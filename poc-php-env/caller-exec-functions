#!/usr/bin/env php
<?php

echo "╔════════════════════════════════════════════════════════════╗\n";
echo "║  Testing PHP Execution Functions                          ║\n";
echo "╚════════════════════════════════════════════════════════════╝\n\n";

putenv('MY_VAR=hello');

// Test 1: passthru() - streams output, gets exit code, NO capture
echo "━━━ 1. passthru() ━━━\n";
echo "Streams: YES | Captures: NO | Exit code: YES\n\n";
$exit_code = 0;
passthru('./callee-slow', $exit_code);
echo "\nExit code: $exit_code\n";
echo "\n";

// Test 2: exec() - NO streaming, captures to array, gets exit code
echo "━━━ 2. exec() ━━━\n";
echo "Streams: NO | Captures: YES (array) | Exit code: YES\n\n";
$output = [];
$exit_code = 0;
exec('./callee-slow', $output, $exit_code);
echo "Output captured as array:\n";
foreach ($output as $line) {
  echo "  - $line\n";
}
echo "Exit code: $exit_code\n";
echo "\n";

// Test 3: shell_exec() - NO streaming, captures to string, NO exit code
echo "━━━ 3. shell_exec() ━━━\n";
echo "Streams: NO | Captures: YES (string) | Exit code: NO\n\n";
$output = shell_exec('./callee-slow');
echo "Output captured as string:\n";
echo $output;
echo "(No exit code available)\n";
echo "\n";

// Test 4: system() - streams output, gets exit code, returns last line
echo "━━━ 4. system() ━━━\n";
echo "Streams: YES | Captures: PARTIAL (last line) | Exit code: YES\n\n";
$exit_code = 0;
$last_line = system('./callee-slow', $exit_code);
echo "\nLast line captured: $last_line\n";
echo "Exit code: $exit_code\n";
echo "\n";

// Test 5: proc_open() - full control, can stream AND capture
echo "━━━ 5. proc_open() ━━━\n";
echo "Streams: YES (with work) | Captures: YES | Exit code: YES\n\n";

$descriptors = [
  0 => ['pipe', 'r'],  // stdin
  1 => ['pipe', 'w'],  // stdout
  2 => ['pipe', 'w'],  // stderr
];

$process = proc_open('./callee-slow', $descriptors, $pipes);

if (is_resource($process)) {
  fclose($pipes[0]);

  stream_set_blocking($pipes[1], false);
  stream_set_blocking($pipes[2], false);

  $captured_output = '';

  while (!feof($pipes[1]) || !feof($pipes[2])) {
    $read = [$pipes[1], $pipes[2]];
    $write = null;
    $except = null;

    if (stream_select($read, $write, $except, 0, 200000)) {
      foreach ($read as $stream) {
        $line = fgets($stream);
        if ($line !== false) {
          echo $line;  // Stream to screen
          $captured_output .= $line;  // Capture to variable
        }
      }
    }
  }

  fclose($pipes[1]);
  fclose($pipes[2]);

  $exit_code = proc_close($process);

  echo "\nCaptured output:\n";
  echo $captured_output;
  echo "Exit code: $exit_code\n";
}

echo "\n";
echo "╔════════════════════════════════════════════════════════════╗\n";
echo "║  Summary                                                   ║\n";
echo "╚════════════════════════════════════════════════════════════╝\n\n";
echo "passthru()   - Best for streaming only, simple\n";
echo "system()     - Like passthru but returns last line\n";
echo "exec()       - Best for capture only, no streaming\n";
echo "shell_exec() - Simple capture, but no exit code\n";
echo "proc_open()  - Best for BOTH streaming AND capture (complex)\n";
