#!/usr/bin/env php
<?php

/**
 * @file
 * Notification dispatch to New Relic.
 */

declare(strict_types=1);

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// New Relic notification project name.
$project = getenv('VORTEX_NOTIFY_NEWRELIC_PROJECT') ?: getenv('VORTEX_NOTIFY_PROJECT');

// New Relic notification User API Key.
//
// To obtain your User API Key:
// 1. Log in to New Relic
// 2. Click on your profile icon (bottom left)
// 3. Go to "API keys"
// 4. Create or copy an existing "User key"
// 5. The key format is: NRAK-XXXXXXXXXXXXXXXXXXXXXX
// .
// @see https://docs.newrelic.com/docs/apis/intro-apis/new-relic-api-keys/#user-key
// @see https://www.vortextemplate.com/docs/workflows/notifications#new-relic
$user_key = getenv('VORTEX_NOTIFY_NEWRELIC_USER_KEY') ?: getenv('NEWRELIC_USER_KEY');

// New Relic notification deployment label (branch name, PR number, or custom).
$label = getenv('VORTEX_NOTIFY_NEWRELIC_LABEL') ?: getenv('VORTEX_NOTIFY_LABEL');

// New Relic notification deployment revision.
//
// If not provided, will be auto-generated as [LABEL]-[TIMESTAMP].
$revision = getenv('VORTEX_NOTIFY_NEWRELIC_REVISION');

// New Relic notification environment URL.
$env_url = getenv('VORTEX_NOTIFY_NEWRELIC_ENVIRONMENT_URL') ?: getenv('VORTEX_NOTIFY_ENVIRONMENT_URL');

// New Relic notification login URL.
$login_url = getenv('VORTEX_NOTIFY_NEWRELIC_LOGIN_URL') ?: getenv('VORTEX_NOTIFY_LOGIN_URL');

// New Relic notification application name as it appears in the dashboard.
$app_name = getenv('VORTEX_NOTIFY_NEWRELIC_APP_NAME') ?: sprintf('%s-%s', $project, $label);

// New Relic notification application ID (auto-discovered if not provided).
//
// Will be discovered automatically from application name if not provided.
$appid = getenv('VORTEX_NOTIFY_NEWRELIC_APPID');

// New Relic notification deployment description template.
//
// Available tokens:
// - %project% - Project name
// - %label% - Deployment label
// - %timestamp% - Deployment timestamp
// - %environment_url% - Environment URL
// - %login_url% - Login URL.
$description = getenv('VORTEX_NOTIFY_NEWRELIC_DESCRIPTION');

// New Relic notification deployment changelog.
// Defaults to the description.
$changelog = getenv('VORTEX_NOTIFY_NEWRELIC_CHANGELOG');

// New Relic notification user performing deployment.
$user = getenv('VORTEX_NOTIFY_NEWRELIC_USER') ?: 'Deployment robot';

// New Relic notification API endpoint.
$endpoint = getenv('VORTEX_NOTIFY_NEWRELIC_ENDPOINT') ?: 'https://api.newrelic.com/v2';

// New Relic notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$event = getenv('VORTEX_NOTIFY_NEWRELIC_EVENT') ?: getenv('VORTEX_NOTIFY_EVENT') ?: 'post_deployment';

// ------------------------------------------------------------------------------
validate_variable('VORTEX_NOTIFY_NEWRELIC_PROJECT');
validate_variable('VORTEX_NOTIFY_NEWRELIC_USER_KEY');
validate_variable('VORTEX_NOTIFY_NEWRELIC_LABEL');
validate_variable('VORTEX_NOTIFY_NEWRELIC_APP_NAME');
validate_variable('VORTEX_NOTIFY_NEWRELIC_USER');

info('Started New Relic notification.');

// Auto-generate revision if not provided (LABEL-YYYYMMDD-HHMMSS).
if (!$revision) {
  $revision_date = date('Ymd');
  $revision_time = date('His');
  $revision = sprintf('%s-%s-%s', $label, $revision_date, $revision_time);
  note('Auto-generated revision: ' . $revision);
}

// Skip if this is a pre-deployment event (New Relic only for post-deployment).
if ($event === 'pre_deployment') {
  pass('Skipping New Relic notification for pre_deployment event.');
  exit(0);
}

// Set default description template if not provided.
if (!$description) {
  $description = "Site %project% %label% has been deployed at %timestamp% and is available at %environment_url%";
}

// Build message by replacing tokens.
$timestamp = date('d/m/Y H:i:s T');

// Replace tokens in description template.
$description = replace_tokens($description, [
  'project' => $project,
  'label' => $label,
  'timestamp' => $timestamp,
  'environment_url' => $env_url,
  'login_url' => $login_url,
]);

// Build changelog if not provided (defaults to description).
if (!$changelog) {
  $changelog = $description;
}

task('Discovering APP id by name if it was not provided.');
if (!$appid && $app_name) {
  $url = sprintf('%s/applications.json?filter[name]=%s&exclude_links=true', $endpoint, urlencode($app_name));
  $response = curl_get($url, [
    'Api-Key: ' . $user_key,
  ]);

  if ($response['ok'] && $response['body']) {
    $data = json_decode((string) $response['body'], TRUE);
    if (isset($data['applications'][0]['id'])) {
      $appid = $data['applications'][0]['id'];
    }
  }
}

// Check if the VORTEX_NOTIFY_NEWRELIC_APPID variable is empty OR
// if the variable doesn't contain only numeric values and exit.
task('Checking if the application ID is valid.');
if (!$appid || !ctype_digit((string) $appid)) {
  note('Notification skipped: No New Relic application ID found for %s. This is expected for non-configured environments.', $app_name);
  exit(0);
}

info('New Relic notification summary:');
note('Project          : ' . $project);
note('Deployment       : ' . $label);
note('App Name         : ' . $app_name);
note('App ID (resolved): ' . $appid);
note('Revision         : ' . $revision);
note('User             : ' . $user);
note('Endpoint         : ' . $endpoint);
note('Description      : ' . $description);

task('Creating a deployment notification for application %s with ID %s.', $app_name, $appid);

$payload_data = [
  'deployment' => [
    'revision' => $revision,
    'changelog' => $changelog,
    'description' => $description,
    'user' => $user,
  ],
];

$url = sprintf('%s/applications/%s/deployments.json', $endpoint, $appid);
$response = curl_post($url, json_encode($payload_data, JSON_UNESCAPED_SLASHES), [
  'Api-Key: ' . $user_key,
  'Content-Type: application/json',
]);

if ($response['status'] !== 201) {
  fail('Failed to create a deployment notification for application %s with ID %s', $app_name, $appid);
}

pass('Finished New Relic notification.');
