#!/usr/bin/env php
<?php

/**
 * @file
 * Notification dispatch to Jira.
 *
 * Features:
 * - posts comment with a URL of a deployment environment
 * - moves an issues to a state
 * - assigns an issue to a dedicated user.
 *
 * Uses user's token to perform operations.
 */

declare(strict_types=1);

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// JIRA notification project name.
$project = getenv('VORTEX_NOTIFY_JIRA_PROJECT') ?: getenv('VORTEX_NOTIFY_PROJECT');

// JIRA notification user email address.
$user_email = getenv('VORTEX_NOTIFY_JIRA_USER_EMAIL');

// JIRA notification API token.
//
// @see https://www.vortextemplate.com/docs/workflows/notifications#jira
$api_token = getenv('VORTEX_NOTIFY_JIRA_TOKEN');

// JIRA notification deployment label (branch name, PR number, or custom).
$label = getenv('VORTEX_NOTIFY_JIRA_LABEL') ?: getenv('VORTEX_NOTIFY_LABEL');

// JIRA notification environment URL.
$env_url = getenv('VORTEX_NOTIFY_JIRA_ENVIRONMENT_URL') ?: getenv('VORTEX_NOTIFY_ENVIRONMENT_URL');

// JIRA notification login URL.
$login_url = getenv('VORTEX_NOTIFY_JIRA_LOGIN_URL') ?: getenv('VORTEX_NOTIFY_LOGIN_URL');

// JIRA notification message template (will be converted to ADF format).
//
// Available tokens:
// - %project% - Project name
// - %label% - Deployment label
// - %timestamp% - Deployment timestamp
// - %environment_url% - Environment URL
// - %login_url% - Login URL.
$message = getenv('VORTEX_NOTIFY_JIRA_MESSAGE');

// JIRA notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$event = getenv('VORTEX_NOTIFY_JIRA_EVENT') ?: getenv('VORTEX_NOTIFY_EVENT') ?: 'post_deployment';

// JIRA notification state to transition to.
//
// If left empty - no transition will be performed.
$transition = getenv('VORTEX_NOTIFY_JIRA_TRANSITION');

// JIRA notification assignee email address.
//
// If left empty - no assignment will be performed.
$assignee_email = getenv('VORTEX_NOTIFY_JIRA_ASSIGNEE_EMAIL');

// JIRA notification API endpoint.
$endpoint = getenv('VORTEX_NOTIFY_JIRA_ENDPOINT') ?: 'https://jira.atlassian.com';

// ------------------------------------------------------------------------------
validate_variable('VORTEX_NOTIFY_JIRA_USER_EMAIL');
validate_variable('VORTEX_NOTIFY_JIRA_TOKEN');
validate_variable('VORTEX_NOTIFY_JIRA_LABEL');
validate_variable('VORTEX_NOTIFY_JIRA_PROJECT');

info('Started JIRA notification.');

// Skip if this is a pre-deployment event (JIRA only processes post-deployment).
if ($event === 'pre_deployment') {
  pass('Skipping JIRA notification for pre_deployment event.');
  exit(0);
}

// Set default message template if not provided.
$message = $message ?: <<<EOT
## This is an automated message ##"

Site %project% %label% has been deployed at %timestamp% and is available at %environment_url%.
Login at: %login_url%
EOT;

/**
 * Extract issue ID from deployment label.
 *
 * @param string $label
 *   Deployment label.
 *
 * @return string|null
 *   Issue ID or NULL if not found.
 */
function extract_issue(string $label): ?string {
  if (preg_match('/([^\/]+\/)?([A-Za-z0-9]+\-\d+)/', $label, $matches)) {
    return $matches[2];
  }
  return NULL;
}

task('Extracting issue');
if (!preg_match('/([^\/]+\/)?([A-Za-z0-9]+\-\d+)/', $label, $matches)) {
  pass('Deployment label %s does not contain issue number.', $label);
}
$issue = $matches[2];
note('Found issue %s.', $issue);

task('Creating API token');
$token = base64_encode(sprintf('%s:%s', $user_email, $api_token));

note('Checking API access...');
$url = sprintf('%s/rest/api/3/myself', $endpoint);
$response = curl_get($url, [
  'Authorization: Basic ' . $token,
  'Content-Type: application/json',
]);

$account_id = 'error';
if ($response['ok'] && $response['body']) {
  $payload = json_decode((string) $response['body'], TRUE);
  $account_id = $payload['accountId'] ?? 'error';
}

if (strlen((string) $account_id) < 24) {
  fail('Unable to authenticate');
}
echo "success\n";

task('Posting a comment.');

validate_variable('VORTEX_NOTIFY_JIRA_ENVIRONMENT_URL');
validate_variable('VORTEX_NOTIFY_JIRA_LOGIN_URL');

// Generate timestamp.
$timestamp = date('d/m/Y H:i:s T');

// Build message by replacing tokens.
$message_content = replace_tokens($message, [
  'project' => $project,
  'label' => $label,
  'timestamp' => $timestamp,
  'environment_url' => $env_url,
  'login_url' => $login_url,
]);

// Build JIRA Atlassian Document Format (ADF) from the message.
$content = [
  [
    'type' => 'paragraph',
    'content' => [
      ['type' => 'text', 'text' => '## This is an automated message ##'],
      ['type' => 'hardBreak'],
      ['type' => 'hardBreak'],
      ['type' => 'text', 'text' => sprintf('Site %s ', $project)],
      ['type' => 'text', 'text' => $label, 'marks' => [['type' => 'code']]],
      ['type' => 'text', 'text' => sprintf(' has been deployed at %s and is available at ', $timestamp)],
      ['type' => 'text', 'text' => $env_url, 'marks' => [['type' => 'link', 'attrs' => ['href' => $env_url]]]],
      ['type' => 'text', 'text' => '.'],
      ['type' => 'hardBreak'],
      ['type' => 'hardBreak'],
      ['type' => 'text', 'text' => 'Login at: '],
      ['type' => 'text', 'text' => $login_url, 'marks' => [['type' => 'link', 'attrs' => ['href' => $login_url]]]],
    ],
  ],
];

$comment_body = [
  'type' => 'doc',
  'version' => 1,
  'content' => $content,
];

info('JIRA notification summary:');
note('Project        : ' . $project);
note('Deployment     : ' . $label);
note('Issue          : ' . $issue);
note('Environment URL: ' . $env_url);
note('Login URL      : ' . $login_url);
note('Endpoint       : ' . $endpoint);
note('User email     : ' . $user_email);
note('Transition     : ' . ($transition ?: '<none>'));
note('Assignee email : ' . ($assignee_email ?: '<none>'));

$payload_data = ['body' => $comment_body];
$url = sprintf('%s/rest/api/3/issue/%s/comment', $endpoint, $issue);
$response = curl_post($url, json_encode($payload_data, JSON_UNESCAPED_SLASHES), [
  'Authorization: Basic ' . $token,
  'Content-Type: application/json',
]);

$comment_id = 'error';
if ($response['ok'] && $response['body']) {
  $payload = json_decode((string) $response['body'], TRUE);
  $comment_id = $payload['id'] ?? 'error';
}

if (!ctype_digit((string) $comment_id)) {
  fail('Unable to create a comment');
}

pass('Posted comment with ID %s.', $comment_id);

if (!empty($transition)) {
  task('Transitioning issue to ' . $transition);

  echo '       Discovering transition ID for ' . $transition . '...';
  $url = sprintf('%s/rest/api/3/issue/%s/transitions', $endpoint, $issue);
  $response = curl_get($url, [
    'Authorization: Basic ' . $token,
    'Content-Type: application/json',
  ]);

  $transition_id = NULL;
  if ($response['ok'] && $response['body']) {
    $payload = json_decode((string) $response['body'], TRUE);
    if (isset($payload['transitions']) && is_array($payload['transitions'])) {
      foreach ($payload['transitions'] as $t) {
        if (isset($t['name']) && $t['name'] === $transition) {
          $transition_id = $t['id'] ?? NULL;
          break;
        }
      }
    }
  }

  if (!$transition_id || !ctype_digit((string) $transition_id)) {
    fail('Unable to retrieve transition ID');
  }
  echo "success\n";

  $payload_data = ['transition' => ['id' => $transition_id]];
  $url = sprintf('%s/rest/api/3/issue/%s/transitions', $endpoint, $issue);
  curl_post($url, json_encode($payload_data), [
    'Authorization: Basic ' . $token,
    'Content-Type: application/json',
  ]);

  pass('Transitioned issue to %s ', $transition);
}

if (!empty($assignee_email)) {
  task('Assigning issue to ' . $assignee_email);

  echo '       Discovering user ID for ' . $assignee_email . '...';
  $url = sprintf('%s/rest/api/3/user/assignable/search?query=%s&issueKey=%s', $endpoint, urlencode($assignee_email), urlencode($issue));
  $response = curl_get($url, [
    'Authorization: Basic ' . $token,
    'Content-Type: application/json',
  ]);

  $assignee_account_id = NULL;
  if ($response['ok'] && $response['body']) {
    $payload = json_decode((string) $response['body'], TRUE);
    if (is_array($payload) && !empty($payload)) {
      $first = reset($payload);
      $assignee_account_id = $first['accountId'] ?? NULL;
    }
  }

  if (!$assignee_account_id || strlen((string) $assignee_account_id) < 24) {
    fail('Unable to retrieve assignee account ID');
  }
  echo "success\n";

  $payload_data = ['accountId' => $assignee_account_id];
  $url = sprintf('%s/rest/api/3/issue/%s/assignee', $endpoint, $issue);
  curl_request($url, [
    'method' => 'PUT',
    'body' => json_encode($payload_data),
    'headers' => [
      'Authorization: Basic ' . $token,
      'Content-Type: application/json',
    ],
  ]);

  pass('Assigned issue to ' . $assignee_email);
}

pass('Finished JIRA notification.');
