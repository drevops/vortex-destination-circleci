#!/usr/bin/env php
<?php

/**
 * @file
 * Notification dispatch to Slack.
 *
 * Sends deployment notifications to Slack channels using Incoming Webhooks.
 */

declare(strict_types=1);

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// Slack notification project name.
$project = getenv('VORTEX_NOTIFY_SLACK_PROJECT') ?: getenv('VORTEX_NOTIFY_PROJECT');

// Slack notification deployment label (branch name, PR number, or custom).
$label = getenv('VORTEX_NOTIFY_SLACK_LABEL') ?: getenv('VORTEX_NOTIFY_LABEL');

// Slack notification environment URL.
$env_url = getenv('VORTEX_NOTIFY_SLACK_ENVIRONMENT_URL') ?: getenv('VORTEX_NOTIFY_ENVIRONMENT_URL');

// Slack notification login URL.
$login_url = getenv('VORTEX_NOTIFY_SLACK_LOGIN_URL') ?: getenv('VORTEX_NOTIFY_LOGIN_URL');

// Slack notification message template (for fallback text).
//
// Available tokens:
// - %project% - Project name
// - %label% - Deployment label
// - %timestamp% - Deployment timestamp
// - %environment_url% - Environment URL
// - %login_url% - Login URL.
$message = getenv('VORTEX_NOTIFY_SLACK_MESSAGE');

// Slack notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$event = getenv('VORTEX_NOTIFY_SLACK_EVENT') ?: getenv('VORTEX_NOTIFY_EVENT') ?: 'post_deployment';

// Slack notification webhook URL.
// The incoming Webhook URL from your Slack app configuration.
// @see https://www.vortextemplate.com/docs/workflows/notifications#slack
$webhook = getenv('VORTEX_NOTIFY_SLACK_WEBHOOK');

// Slack notification target channel (optional, overrides webhook default).
// Format: #channel-name or @username
$channel = getenv('VORTEX_NOTIFY_SLACK_CHANNEL');

// Slack notification bot display name (optional).
$username = getenv('VORTEX_NOTIFY_SLACK_USERNAME') ?: 'Deployment Bot';

// Slack notification bot icon emoji (optional).
$icon = getenv('VORTEX_NOTIFY_SLACK_ICON_EMOJI') ?: ':rocket:';

// ------------------------------------------------------------------------------
validate_variable('VORTEX_NOTIFY_SLACK_PROJECT');
validate_variable('VORTEX_NOTIFY_SLACK_LABEL');
validate_variable('VORTEX_NOTIFY_SLACK_ENVIRONMENT_URL');
validate_variable('VORTEX_NOTIFY_SLACK_LOGIN_URL');
validate_variable('VORTEX_NOTIFY_SLACK_WEBHOOK');

info('Started Slack notification.');

// Set default message template if not provided.
if (!$message) {
  $message = "## This is an automated message ##\n\n" .
    "Site %project% %label% has been deployed at %timestamp% and is available at %environment_url%.\n\n" .
    "Login at: %login_url%";
}

// Generate timestamp.
$timestamp = date('d/m/Y H:i:s T');

// Build fallback message by replacing tokens.
$fallback_message = replace_tokens($message, [
  'project' => $project,
  'label' => $label,
  'timestamp' => $timestamp,
  'environment_url' => $env_url,
  'login_url' => $login_url,
]);

// Determine color based on event type.
$color = 'good';
$event_label = 'Deployment Complete';
if ($event === 'pre_deployment') {
  $color = '#808080';
  $event_label = 'Deployment Starting';
}

// Build the message title.
$title = sprintf('%s: %s', $event_label, $project);

// Build payload.
$data = [
  'username' => $username,
  'icon_emoji' => $icon,
  'attachments' => [
    [
      'color' => $color,
      'fallback' => $fallback_message,
      'title' => $title,
      'fields' => [
        ['title' => 'Deployment', 'value' => $label, 'short' => TRUE],
        ['title' => 'Environment', 'value' => sprintf('<%s|View Site>', $env_url), 'short' => TRUE],
        ['title' => 'Login', 'value' => sprintf('<%s|Login Here>', $login_url), 'short' => TRUE],
        ['title' => 'Time', 'value' => $timestamp, 'short' => TRUE],
      ],
      'footer' => 'Vortex Deployment',
      'ts' => time(),
    ],
  ],
];

if (!empty($channel)) {
  $data['channel'] = $channel;
}

$payload = json_encode($data, JSON_UNESCAPED_SLASHES);

// Extract webhook domain for display (hide secret path).
$webhook_domain = parse_url($webhook, PHP_URL_SCHEME) . '://' . parse_url($webhook, PHP_URL_HOST);

info('Slack notification summary:');
note('Project        : ' . $project);
note('Deployment     : ' . $label);
note('Environment URL: ' . $env_url);
note('Login URL      : ' . $login_url);
note('Webhook        : %s/***', $webhook_domain);
note('Channel        : ' . ($channel ?: '<default>'));
note('Username       : ' . $username);
note('Event          : ' . $event_label);

// Send notification to Slack.
$response = curl_post($webhook, $payload, [
  'Content-Type: application/json',
]);

if ($response['status'] !== 200) {
  fail('Unable to send notification to Slack. HTTP status: %s', $response['status']);
}

note('Notification sent to Slack.');
note('Project: ' . $project);
note('Deployment: ' . $label);
note('Environment URL: ' . $env_url);

pass('Finished Slack notification.');
