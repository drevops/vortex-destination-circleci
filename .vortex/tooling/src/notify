#!/usr/bin/env php
<?php

/**
 * @file
 * Notify about events.
 *
 * This is a router script to call relevant scripts based on type.
 */

declare(strict_types=1);

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// Notification channels.
//
// Comma-separated values: email,slack,newrelic,github,jira,webhook.
$channels = getenv('VORTEX_NOTIFY_CHANNELS') ?: 'email';

// Notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$event = getenv('VORTEX_NOTIFY_EVENT') ?: 'post_deployment';

// Notification skip flag.
$skip = getenv('VORTEX_NOTIFY_SKIP');

// Notification project name.
$project = getenv('VORTEX_NOTIFY_PROJECT') ?: getenv('VORTEX_PROJECT');

// Notification deployment label (branch name, PR number, or custom identifier).
$label = getenv('VORTEX_NOTIFY_LABEL');

// Notification environment URL (where the site was deployed).
$env_url = getenv('VORTEX_NOTIFY_ENVIRONMENT_URL');

// Notification login URL (defaults to ENVIRONMENT_URL/user/login).
$login_url = getenv('VORTEX_NOTIFY_LOGIN_URL');

// ------------------------------------------------------------------------------
info('Started dispatching notifications.');

if ($skip) {
  pass('Skipping dispatching notifications.');
  exit(0);
}

validate_variable('VORTEX_NOTIFY_LABEL');
validate_variable('VORTEX_NOTIFY_ENVIRONMENT_URL');

// Validate event type.
if (!in_array($event, ['pre_deployment', 'post_deployment'])) {
  fail('Unsupported event %s provided.', $event);
}

// Auto-generate LOGIN_URL if not provided.
if (!$login_url) {
  $login_url = rtrim($env_url, '/') . '/user/login';
  putenv('VORTEX_NOTIFY_LOGIN_URL=' . $login_url);
}

// Route to channel-specific scripts.
$channels = array_map(trim(...), explode(',', $channels));

$failed = FALSE;

foreach ($channels as $channel) {
  if (empty($channel)) {
    continue;
  }

  $script = __DIR__ . ('/notify-' . $channel);

  if (!file_exists($script) || !is_executable($script)) {
    fail_no_exit("Notification script for channel '%s' not found or is not executable: %s", $channel, $script);
    $failed = TRUE;
    continue;
  }

  $exit_code = 0;
  passthru(sprintf('"%s"', $script), $exit_code);

  if ($exit_code !== 0) {
    fail_no_exit('Notification to %s failed with exit code %s', $channel, $exit_code);
    $failed = TRUE;
  }
}

if ($failed) {
  fail('Some notifications failed.');
}

pass('Finished dispatching notifications.');
