#!/usr/bin/env php
<?php

/**
 * @file
 * Notification dispatch to any webhook.
 */

declare(strict_types=1);

namespace DrevOps\VortexTooling;

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// Webhook notification project name.
$project = getenv('VORTEX_NOTIFY_WEBHOOK_PROJECT') ?: getenv('VORTEX_NOTIFY_PROJECT');

// Webhook notification deployment label (branch name, PR number, or custom).
$label = getenv('VORTEX_NOTIFY_WEBHOOK_LABEL') ?: getenv('VORTEX_NOTIFY_LABEL');

// Webhook notification environment URL.
$env_url = getenv('VORTEX_NOTIFY_WEBHOOK_ENVIRONMENT_URL') ?: getenv('VORTEX_NOTIFY_ENVIRONMENT_URL');

// Webhook notification login URL.
$login_url = getenv('VORTEX_NOTIFY_WEBHOOK_LOGIN_URL') ?: getenv('VORTEX_NOTIFY_LOGIN_URL');

// Webhook notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$event = getenv('VORTEX_NOTIFY_WEBHOOK_EVENT') ?: getenv('VORTEX_NOTIFY_EVENT') ?: 'post_deployment';

// Webhook notification endpoint URL.
$webhook_url = getenv('VORTEX_NOTIFY_WEBHOOK_URL');

// Webhook notification HTTP method like POST, GET, PUT.
$method = getenv('VORTEX_NOTIFY_WEBHOOK_METHOD') ?: 'POST';

// Webhook notification pipe-separated headers.
// Separate multiple headers with a pipe `|`.
// Example: `Content-type: application/json|Authorization: Bearer API_KEY`.
$headers = getenv('VORTEX_NOTIFY_WEBHOOK_HEADERS') ?: 'Content-type: application/json';

// Webhook notification JSON payload.
//
// Available tokens:
// - %project% - Project name
// - %label% - Deployment label
// - %timestamp% - Deployment timestamp
// - %environment_url% - Environment URL
// - %login_url% - Login URL.
$payload = getenv('VORTEX_NOTIFY_WEBHOOK_PAYLOAD');

// Webhook notification expected HTTP status.
$expected_status = getenv('VORTEX_NOTIFY_WEBHOOK_RESPONSE_STATUS') ?: '200';

// ------------------------------------------------------------------------------
validate_variable('VORTEX_NOTIFY_WEBHOOK_PROJECT');
validate_variable('VORTEX_NOTIFY_WEBHOOK_LABEL');
validate_variable('VORTEX_NOTIFY_WEBHOOK_ENVIRONMENT_URL');
validate_variable('VORTEX_NOTIFY_WEBHOOK_LOGIN_URL');
validate_variable('VORTEX_NOTIFY_WEBHOOK_URL');
validate_variable('VORTEX_NOTIFY_WEBHOOK_METHOD');
validate_variable('VORTEX_NOTIFY_WEBHOOK_HEADERS');

info('Started Webhook notification.');

// Skip if this is a pre-deployment event (webhook only for post-deployment).
if ($event === 'pre_deployment') {
  pass('Skipping Webhook notification for pre_deployment event.');
  exit(0);
}

// Set default payload template if not provided.
if (!$payload) {
  $payload = '{"channel": "Channel 1", "message": "%message%", "project": "%project%", "label": "%label%", "timestamp": "%timestamp%", "environment_url": "%environment_url%", "login_url": "%login_url%"}';
}

/**
 * JSON-escape a value for insertion into JSON template.
 *
 * @param string $value
 *   Value to escape.
 *
 * @return string
 *   JSON-escaped value without surrounding quotes.
 */
function json_escape_value(string $value): string {
  $escaped = json_encode($value);
  // Remove surrounding quotes.
  return substr($escaped, 1, -1);
}

// Build and replace tokens (%variable_name%) for webhook payload.
$timestamp = date('d/m/Y H:i:s T');
$message = "## This is an automated message ##\nSite %project% %label% has been deployed at %timestamp% and is available at %environment_url%.\nLogin at: %login_url%";

// JSON-escape each replacement value before substituting into JSON template.
$replacements = [
  'message' => json_escape_value($message),
  'timestamp' => json_escape_value($timestamp),
  'label' => json_escape_value($label),
  'project' => json_escape_value($project),
  'environment_url' => json_escape_value($env_url),
  'login_url' => json_escape_value($login_url),
];

foreach ($replacements as $token => $value) {
  $payload = str_replace(sprintf('%%%s%%', $token), $value, $payload);
}

// Sanitize webhook URL (extract domain, hide path that may contain secrets).
$webhook_domain = preg_replace('|(https?://[^/]+).*|', '$1', $webhook_url);

info('Webhook notification summary:');
note('Project            : ' . $project);
note('Deployment         : ' . $label);
note('Environment URL    : ' . $env_url);
note('Login URL          : ' . $login_url);
note('Webhook URL        : %s/***', $webhook_domain);
note('Method             : ' . $method);
note('Headers            : ' . $headers);
note('Expected Status    : ' . $expected_status);
note('Payload (first 200): ' . substr($payload, 0, 200) . '...');

// Build headers array.
$headers_array = array_map(trim(...), explode('|', $headers));

// Send webhook notification.
$response = curl_request($webhook_url, [
  'method' => $method,
  'headers' => $headers_array,
  'body' => $payload,
]);

if ($response['status'] !== (int) $expected_status) {
  fail(sprintf('Unable to send notification to webhook %s.', $webhook_url));
}

pass('Finished Webhook notification.');
